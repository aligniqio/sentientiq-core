# SentientIQ Pipeline Handoff - January 17, 2025

## Current System Status
The behavioral telemetry and intervention system is partially operational with performance issues resolved but data flow interrupted.

## Architecture Overview
```
Marketing Site (sentientiq.ai)
    → GTM loads sentientiq-unified.js
    → Captures 120Hz biomechanical telemetry
    ↓
Telemetry Gateway (EC2 port 3002)
    → WebSocket: wss://api.sentientiq.app/ws/telemetry
    → Receives raw telemetry events
    → Writes to Redis Stream: telemetry_events
    ↓
Redis (EC2)
    → Stream: telemetry_events (raw telemetry)
    → Pub/Sub: emotional_events (processed emotions)
    ↓
Behavior Processor (EC2 - PM2: behavior-processor-production)
    → Reads from Redis stream telemetry_events
    → Processes into emotional states (rage, frustration, etc.)
    → Publishes to Redis channel: emotional_events
    → Stores in Supabase table: emotional_events
    ↓
Emotional Broadcaster (EC2 port 3003)
    → WebSocket: wss://api.sentientiq.app/ws/emotions
    → Subscribes to Redis channel: emotional_events
    → Broadcasts to dashboard
    ↓
Dashboard (www.sentientiq.app)
    → EmotionalStream.tsx component
    → Displays real-time emotional events
    ↓
Intervention Broadcaster (EC2 port 3004)
    → WebSocket: wss://api.sentientiq.app/ws/interventions
    → Should trigger based on emotional patterns
    → Status: NEEDS VERIFICATION

```

## What's Working
1. ✅ **Telemetry script deployed via GTM** - "SentientIQ - Unified v2" tag
2. ✅ **WebSocket connections established** - All three endpoints connecting
3. ✅ **Dashboard performance fixed** - No more Chrome-killing floods
4. ✅ **Basic pipeline proven** - Successfully processed 1000+ rage events (too successfully!)

## Current Issue: No Data Flow
Despite the marketing site (sentientiq.ai) being active and telemetry script loaded:
- **No emotional events appearing in dashboard**
- **Possible causes:**
  1. Telemetry not actually firing from marketing site
  2. Telemetry Gateway not receiving/processing
  3. Behavior processor not reading from Redis
  4. Redis stream/channel misconfiguration

## Key Files & Locations

### Local (Your Machine)
- `/Users/matthewkiselstein/projects/sentientiq-core/marketing-website/public/sentientiq-unified.js` - Main telemetry script
- `/Users/matthewkiselstein/projects/sentientiq-core/src/components/EmotionalStream.tsx` - Dashboard component (with performance fixes)
- `/Users/matthewkiselstein/projects/sentientiq-core/src/components/InterventionStream.tsx` - Intervention display

### EC2 Server
- `/home/ec2-user/telemetry-gateway.cjs` - Receives raw telemetry
- `/home/ec2-user/behavior-processor-production.cjs` - Processes emotions
- `/home/ec2-user/emotional-broadcaster.cjs` - Broadcasts to dashboard
- `/home/ec2-user/intervention-broadcaster.cjs` - Triggers interventions

### Configuration
- Nginx: `/etc/nginx/conf.d/` - WebSocket proxies
- PM2 processes: `pm2 list` shows all running services
- Environment: `.env` files in `/home/ec2-user/`

## Debug Steps to Try

### 1. Verify Telemetry is Firing
```javascript
// Browser console on sentientiq.ai
window.SentientIQ // Should exist
// Check Network tab for WSS connection to api.sentientiq.app/ws/telemetry
```

### 2. Check Telemetry Gateway (EC2)
```bash
pm2 logs telemetry-gateway
# Look for incoming telemetry events

# Check Redis for raw events
redis-cli
> XLEN telemetry_events
> XREAD COUNT 5 STREAMS telemetry_events $
```

### 3. Check Behavior Processor (EC2)
```bash
pm2 logs behavior-processor-production
# Should show "Processing event" logs

# Check Redis pub/sub
redis-cli
> SUBSCRIBE emotional_events
# Should see emotional state messages
```

### 4. Check Emotional Broadcaster (EC2)
```bash
pm2 logs emotional-broadcaster
# Should show "Broadcasting emotional state" logs
```

### 5. Verify Supabase Connection
```bash
# Check environment variables
cat /home/ec2-user/.env | grep SUPABASE

# Look for recent entries in Supabase dashboard
# Table: emotional_events
```

## Recent Changes That Worked

### EmotionalStream.tsx Performance Fixes
1. Added event queue with batch processing (max 2-3 events at a time)
2. Implemented auto-flush when queue > 30 or display > 20
3. Added manual clear button
4. Deferred message processing with `setTimeout(..., 0)`
5. Simplified animations (removed spring physics)
6. Rate limiting after flush events

### Fixed Issues
- ✅ Missing `setupViewportTracking()` method in telemetry script
- ✅ GTM caching issues (created new tag v2)
- ✅ Supabase table name (emotional_states → emotional_events)
- ✅ Redis channel mismatch (emotional_states → emotional_events)
- ✅ Behavior processor reading from wrong position ($ → 0)

## Next Steps Priority

### Immediate (Fix Data Flow)
1. **Verify telemetry is actually sending** from marketing site
2. **Check telemetry gateway logs** for incoming connections
3. **Ensure Redis streams are being written/read**
4. **Confirm all PM2 processes are healthy**

### Once Pipeline Working
1. **Test intervention broadcaster** - Ensure interventions trigger on emotional patterns
2. **Fine-tune rage detection** - Current 120Hz sampling might be too sensitive
3. **Implement intervention logic** - Cart abandonment, price shock responses

### Future Enhancements (After Core Pipeline)
1. **Add ML capabilities** with pandas/scikit-learn:
   - Anomaly detection for unusual behaviors
   - Pattern clustering for user segmentation
   - Predictive models for abandonment prevention
   - Time-series analysis of mouse trajectories

## Critical Services Status Check
```bash
# On EC2
pm2 list  # All should be "online"
pm2 restart all  # If needed

# Check Redis
redis-cli ping  # Should return PONG

# Check nginx
sudo systemctl status nginx

# Check WebSocket endpoints
curl https://api.sentientiq.app/health
```

## Environment Variables Needed
```bash
# In /home/ec2-user/.env
REDIS_HOST=localhost
REDIS_PORT=6379
SUPABASE_URL=https://[project].supabase.co
SUPABASE_KEY=[anon-key]
SUPABASE_SERVICE_KEY=[service-key]
```

## Known Issues / Gotchas
1. **GTM caching** - Always create new tag versions when updating
2. **Node module conflicts** - Watch for "type": "module" issues
3. **Performance flooding** - System can generate 1000+ events quickly at 120Hz
4. **WebSocket timeouts** - 60s timeouts configured in nginx

## Support Info
- Dashboard: https://www.sentientiq.app (requires auth)
- Marketing site: https://sentientiq.ai
- API endpoints: https://api.sentientiq.app
- Supabase dashboard: Check project for emotional_events table
- PM2 web dashboard: `pm2 web` (if configured)

## Final Notes
The core architecture is solid and has been proven to work (we successfully processed 1000+ rage events!). The current issue appears to be a simple disconnect in the pipeline - likely the telemetry isn't firing from the marketing site or the gateway isn't receiving it. Start debugging from the browser side and work your way through the pipeline.

The performance issues in the dashboard have been resolved with batching and throttling. The system can now handle high-volume events without killing Chrome.

Good luck! The pipeline is close - just needs that data flowing again.