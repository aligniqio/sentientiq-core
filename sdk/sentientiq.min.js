!function(e,t){"use strict";const n="5.0.0",i="wss://stream.sentientiq.app",s="https://beacon.sentientiq.app/v1/events",o=100,a=1e3,r=1e3,c=5,l=50,u=.95,d=800,h=300,m={initialized:!1,apiKey:null,sessionId:null,userId:null,userTraits:{},ws:null,worker:null,connected:!1,reconnectAttempts:0,eventQueue:[],lastActivity:Date.now(),mousePosition:{x:0,y:0},scrollPosition:0,velocity:0,acceleration:0,currentSection:null,sectionObserver:null,init:function(e,t={}){if(!this.initialized){if(this.apiKey=e||this.extractApiKey(),!this.apiKey)return void console.error("SentientIQ: No API key provided");this.sessionId=this.generateSessionId(),this.initialized=!0,this.autoIdentify(),this.setupWorker(),this.connect(),this.setupListeners(),this.setupSectionObserver(),this.startHeartbeat(),t.debug&&console.log("SentientIQ initialized:",{version:n,sessionId:this.sessionId,userId:this.userId}),this.emit("ready")}},identify:function(e,t={}){this.userId=e,this.userTraits=t;const n=t.ltv||t.value||t.revenue||0;this.send({type:"identify",userId:e,traits:t,ltv:n,timestamp:Date.now()});try{localStorage.setItem("sq_user",JSON.stringify({userId:e,traits:t}))}catch(e){}},autoIdentify:function(){try{const e=localStorage.getItem("sq_user");if(e){const{userId:t,traits:n}=JSON.parse(e);return this.userId=t,void(this.userTraits=n)}}catch(e){}const t=[()=>e.Clerk?.user?.id,()=>e.auth0?.user?.sub,()=>e.firebase?.auth()?.currentUser?.uid,()=>e.supabase?.auth?.user()?.id,()=>e.user?.id,()=>e.currentUser?.id,()=>t.querySelector("[data-user-id]")?.dataset.userId];for(const e of t)try{const t=e();if(t){this.identify(t);break}}catch(e){}},setupWorker:function(){if(!e.Worker)return;const t=new Blob(["\n        let eventBuffer = [];\n        let sending = false;\n\n        self.onmessage = function(e) {\n          const { type, data } = e.data;\n          \n          if (type === 'event') {\n            eventBuffer.push(data);\n            \n            if (eventBuffer.length >= 10 && !sending) {\n              flush();\n            }\n          }\n        };\n\n        function flush() {\n          if (eventBuffer.length === 0 || sending) return;\n          \n          sending = true;\n          const events = eventBuffer.splice(0, 10);\n          \n          self.postMessage({\n            type: 'batch',\n            events: events\n          });\n          \n          sending = false;\n        }\n\n        setInterval(flush, 1000);\n      "],{type:"application/javascript"}),n=URL.createObjectURL(t);this.worker=new Worker(n),this.worker.onmessage=e=>{"batch"===e.data.type&&this.sendBatch(e.data.events)}},connect:function(){if(this.ws&&this.ws.readyState===WebSocket.OPEN)return;const e=`${i}?api_key=${this.apiKey}&session=${this.sessionId}`;try{this.ws=new WebSocket(e),this.ws.onopen=()=>{this.connected=!0,this.reconnectAttempts=0,this.flushQueue()},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleIntervention(t)}catch(e){}},this.ws.onclose=()=>{this.connected=!1,this.reconnect()},this.ws.onerror=()=>{this.connected=!1}}catch(e){this.connected=!1}},reconnect:function(){this.reconnectAttempts>=c||setTimeout(()=>{this.reconnectAttempts++,this.connect()},r*Math.pow(2,this.reconnectAttempts))},setupListeners:function(){let n=0;t.addEventListener("mousemove",i=>{const s=Date.now();if(s-n<l)return;n=s;const o=i.clientX-this.mousePosition.x,a=i.clientY-this.mousePosition.y,r=Math.sqrt(o*o+a*a)/l*1e3;this.acceleration=r-this.velocity,this.velocity=r,this.velocity>d&&this.acceleration>500&&this.detectEmotion("rage",95),this.mousePosition={x:i.clientX,y:i.clientY},this.queueEvent({type:"mousemove",x:i.clientX,y:i.clientY,velocity:this.velocity,acceleration:this.acceleration})}),t.addEventListener("click",e=>{const t=e.target,n=this.getElementIdentifier(t);this.queueEvent({type:"click",element:n,x:e.clientX,y:e.clientY,section:this.currentSection}),"pricing"===this.currentSection&&t.matches("[data-cta], .cta, .btn-primary")&&this.detectEmotion("purchase_intent",90)});let i=0,s=e.scrollY;e.addEventListener("scroll",()=>{const t=Date.now();if(t-i<l)return;const n=e.scrollY-s,o=Math.abs(n)/(t-i)*1e3;this.queueEvent({type:"scroll",position:e.scrollY,velocity:o,direction:n>0?"down":"up"}),i=t,s=e.scrollY}),t.addEventListener("visibilitychange",()=>{t.hidden&&(this.queueEvent({type:"visibility",hidden:!0}),this.velocity>600&&this.detectEmotion("abandonment_risk",85))}),e.addEventListener("beforeunload",()=>{this.velocity>d&&this.sendBeacon({type:"emotion",emotion:"rage_quit",confidence:99,velocity:this.velocity})})},setupSectionObserver:function(){const n=t.querySelectorAll("[data-section], section, .section, #hero, #pricing, #demo, #testimonials");e.IntersectionObserver&&0!==n.length&&(this.sectionObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting&&e.intersectionRatio>.5){const t=e.target.dataset.section||e.target.id||e.target.className;t!==this.currentSection&&this.handleSectionChange(t)}})},{threshold:.5}),n.forEach(e=>{this.sectionObserver.observe(e)}))},handleSectionChange:function(e){const t=this.currentSection;this.currentSection=e,this.queueEvent({type:"section_change",from:t,to:e,timestamp:Date.now()}),"pricing"===e?this.velocity>500&&this.detectEmotion("price_curiosity",70):"testimonials"===e&&this.detectEmotion("trust_building",65)},detectEmotion:function(e,t){const n={type:"emotion",emotion:e,confidence:t,section:this.currentSection,velocity:this.velocity,userId:this.userId,ltv:this.userTraits.ltv||0,timestamp:Date.now()};t>85&&this.userTraits.ltv>1e4?this.send(n):this.queueEvent(n),this.emit("emotion",n)},queueEvent:function(e){e.sessionId=this.sessionId,e.userId=this.userId,e.timestamp=e.timestamp||Date.now(),this.worker?this.worker.postMessage({type:"event",data:e}):(this.eventQueue.push(e),this.eventQueue.length>=o&&this.flushQueue())},send:function(e){this.connected&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):this.sendBeacon(e)},sendBatch:function(e){this.connected&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify({type:"batch",events:e})):navigator.sendBeacon(s,JSON.stringify({apiKey:this.apiKey,sessionId:this.sessionId,events:e}))},sendBeacon:function(e){navigator.sendBeacon&&navigator.sendBeacon(s,JSON.stringify({apiKey:this.apiKey,sessionId:this.sessionId,event:e}))},flushQueue:function(){if(0===this.eventQueue.length)return;const e=this.eventQueue.splice(0,o);this.sendBatch(e)},handleIntervention:function(e){if("intervention"===e.type)switch(this.emit("intervention",e),e.action){case"show_chat":this.showChat(e);break;case"show_discount":this.showDiscount(e);break;case"highlight_element":this.highlightElement(e)}},showChat:function(t){e.Intercom?(e.Intercom("show"),e.Intercom("showNewMessage",t.message)):e.zE&&(e.zE("webWidget","open"),e.zE("webWidget","chat:send",t.message))},showDiscount:function(e){const n=t.createElement("div");n.className="sq-discount-banner",n.innerHTML=`\n        <div style="position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:99999;max-width:300px;animation:slideIn 0.3s ease;">\n          <div style="font-size:18px;font-weight:bold;margin-bottom:10px;">ðŸ’Ž Special Offer</div>\n          <div style="margin-bottom:15px;">${e.message||"Get 20% off your first month"}</div>\n          <button onclick="SentientIQ.acceptOffer('${e.offerId}')" style="background:white;color:#667eea;border:none;padding:10px 20px;border-radius:5px;font-weight:bold;cursor:pointer;">Claim Now</button>\n        </div>\n      `,t.body.appendChild(n),setTimeout(()=>n.remove(),3e4)},acceptOffer:function(e){this.queueEvent({type:"offer_accepted",offerId:e}),t.querySelector(".sq-discount-banner")?.remove()},highlightElement:function(e){const n=t.querySelector(e.selector);n&&(n.style.transition="all 0.3s ease",n.style.boxShadow="0 0 20px rgba(102, 126, 234, 0.8)",n.style.transform="scale(1.05)",setTimeout(()=>{n.style.boxShadow="",n.style.transform=""},3e3))},startHeartbeat:function(){setInterval(()=>{this.flushQueue(),Date.now()-this.lastActivity<3e4&&this.queueEvent({type:"heartbeat",section:this.currentSection})},3e4)},getElementIdentifier:function(e){return e.id||e.dataset.track||e.className||e.tagName.toLowerCase()},extractApiKey:function(){const e=t.currentScript||t.querySelector("script[data-api-key]");return e?.dataset.apiKey},generateSessionId:function(){return`sq_${Date.now()}_${Math.random().toString(36).substring(2,11)}`},listeners:{},on:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},emit:function(e,t){this.listeners[e]&&this.listeners[e].forEach(n=>{try{n(t)}catch(t){console.error("SentientIQ: Event handler error",t)}})},track:function(e,t={}){this.queueEvent({type:"custom",event:e,properties:t})},page:function(t,n={}){this.queueEvent({type:"page",name:t,properties:n,url:e.location.href})},revenue:function(e,t={}){this.queueEvent({type:"revenue",amount:e,properties:t})}};t.currentScript?.dataset.apiKey&&("loading"===t.readyState?t.addEventListener("DOMContentLoaded",()=>{m.init()}):m.init()),"undefined"!=typeof module&&module.exports?module.exports=m:"function"==typeof define&&define.amd?define([],function(){return m}):e.SentientIQ=m}(window,document);