# SentientIQ Pipeline Handoff - January 18, 2025

## Current State: NATS Working But Behavior Processor Needs Fix

### ‚úÖ What's Working
- **NATS JetStream** is rock solid - no more WebSocket flapping!
- **SSL proxy configured** at `wss://api.sentientiq.app/ws/nats`
- **Dashboard connects reliably** using simple NATS subscriptions
- **Manual emotional events flow perfectly** through the pipeline
- **No more React double-mounting issues** with NATS

### üî¥ Critical Issue: Behavior Processor Flooding

**THE PROBLEM:** The behavior processor reads the ENTIRE Redis stream history every time it starts, causing:
- Hundreds of thousands of events to flood the dashboard
- 922,000+ events replayed from JetStream history
- Browser crashes from DOM overload
- Memory explosion (NATS WS proxy hit 600MB+)

**CURRENT STATUS:**
- `behavior-processor` is STOPPED (pm2 id: 19)
- `nats-publisher` is running
- Redis stream `telemetry:raw` has been cleared
- Pipeline works with manual events but NOT with telemetry ‚Üí emotion conversion

### üõ† What Needs Fixing

#### 1. Behavior Processor Stream Position Tracking
The processor needs to track its position in the Redis stream:
```javascript
// In behavior-processor-production.cjs
// Need to implement:
- Store last processed ID in Redis: `behavior:last_processed_id`
- On startup: XREAD from that position, not from '0'
- Update position after each batch
```

#### 2. Current Files on EC2
```bash
/home/ec2-user/behavior-processor-production.cjs  # Main processor (has 150% frustration bug)
/home/ec2-user/nats-emotional-publisher.cjs       # Bridges Redis ‚Üí NATS (working)
/home/ec2-user/nats-ws-proxy.js                   # WebSocket proxy on 9222 (working)
```

#### 3. PM2 Process Status
```bash
# View all processes
pm2 list

# Key processes:
- behavior-processor (id: 19) - STOPPED - needs position tracking
- nats-publisher (id: 17) - Running
- nats-ws-proxy (id: 18) - Running (but high memory from flooding)
- telemetry-gateway-fixed (id: 15) - Running
```

### üìù Architecture Overview

```
Telemetry ‚Üí Gateway (3002) ‚Üí Redis Stream (telemetry:raw)
                                    ‚Üì
                         Behavior Processor [NEEDS FIX]
                                    ‚Üì
                         Redis Pub/Sub (emotional_events)
                                    ‚Üì
                         NATS Publisher ‚Üí JetStream
                                    ‚Üì
                         NATS WS Proxy (9222) ‚Üí nginx SSL
                                    ‚Üì
                         Dashboard (wss://api.sentientiq.app/ws/nats)
```

### üö® Important Notes

1. **DO NOT start behavior processor without fixing position tracking** - it will flood everything again

2. **NATS is configured correctly** - uses simple subscriptions, not JetStream consumers (avoids replay)

3. **The emotional vectors are still uncapped** - frustration can hit 150%+ (we added Math.min fix but needs verification)

4. **Two different dashboard routes exist:**
   - `/pulse` in `src/product/App.tsx` - loads bare stream components
   - `src/pages/pulse/index.tsx` - full dashboard (but not routed anywhere!)

5. **PageHeader issue:** The Pulse dashboard page exists but isn't properly routed through the app

### üí° Quick Fixes to Try

#### Fix Behavior Processor Position Tracking:
```bash
ssh ec2-user@api.sentientiq.app

# Edit the processor to add position tracking
nano /home/ec2-user/behavior-processor-production.cjs

# Add after Redis connection:
const lastId = await redis.get('behavior:last_processed_id') || '0';

# Change XREAD to use lastId:
const messages = await redis.xread(
  'BLOCK', 1000,
  'STREAMS', 'telemetry:raw', lastId
);

# After processing, save position:
await redis.set('behavior:last_processed_id', messages[0][1][messages[0][1].length-1][0]);
```

#### Test Single Event Flow:
```bash
# Send test emotional event (bypasses behavior processor)
redis6-cli PUBLISH emotional_events '{"sessionId":"TEST","emotion":"joy","confidence":90,"timestamp":"2025-01-18T00:00:00Z"}'
```

#### Emergency Stop Flooding:
```bash
pm2 stop behavior-processor
pm2 stop nats-publisher
redis6-cli DEL telemetry:raw
```

### üéØ Next Steps

1. **Implement stream position tracking** in behavior processor
2. **Route the Pulse dashboard page** properly in the app
3. **Add rate limiting** to prevent flooding even with bugs
4. **Consider using Redis Streams consumer groups** for automatic position tracking
5. **Add monitoring/alerts** for queue depth

### üîë Key Learnings

- NATS JetStream is solid but needs careful consumer configuration
- Redis Streams need position tracking or consumer groups
- WebSockets are unreliable - NATS was the right choice
- Always implement rate limiting and circuit breakers
- Test with small data sets before opening the floodgates

### üìû Contact

The user has people waiting to use this. The pipeline MUST be bulletproof before launch. The concept of "visible human signals over intent data guessing" is resonating strongly.

**Current blocking issue:** Behavior processor floods the pipeline with historical events. Fix the position tracking and this thing is ready to ship.

---
*Generated after 2+ days of debugging WebSocket issues, implementing NATS, and fighting event flooding*