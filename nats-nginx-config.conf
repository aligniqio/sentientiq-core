# NATS WebSocket SSL Proxy Configuration
# Add this to /etc/nginx/conf.d/nats-websocket.conf on the EC2 instance

# NATS WebSocket proxy (port 9222 -> SSL on 9223)
location /nats {
    proxy_pass http://localhost:9222;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket specific
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
    proxy_connect_timeout 60s;

    # Disable buffering for real-time
    proxy_buffering off;
    proxy_cache off;

    # NATS specific headers
    proxy_set_header Sec-WebSocket-Protocol $http_sec_websocket_protocol;
    proxy_set_header Sec-WebSocket-Extensions $http_sec_websocket_extensions;
    proxy_set_header Sec-WebSocket-Key $http_sec_websocket_key;
    proxy_set_header Sec-WebSocket-Version $http_sec_websocket_version;
}

# Alternative: Direct port proxy (requires opening port 9223 in security group)
# server {
#     listen 9223 ssl;
#     server_name api.sentientiq.app;
#
#     ssl_certificate /etc/letsencrypt/live/api.sentientiq.app/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/api.sentientiq.app/privkey.pem;
#
#     location / {
#         proxy_pass http://localhost:9222;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#         proxy_read_timeout 86400;
#     }
# }