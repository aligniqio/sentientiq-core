<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SentientIQ GTM Script - Correct Implementation</title>
</head>
<body>
    <h1>SentientIQ GTM Script - Production Ready</h1>
    <h2>Complete Script for Google Tag Manager Custom HTML Tag</h2>

    <p>This script properly loads both detection and intervention scripts with correct communication between them.</p>

    <h3>Instructions:</h3>
    <ol>
        <li>Go to Google Tag Manager (Container: GTM-P5SL4DLB)</li>
        <li>Create a new Custom HTML Tag</li>
        <li>Copy the script below</li>
        <li>Set trigger to "All Pages"</li>
        <li>Publish the container</li>
    </ol>

    <h3>The Complete Script:</h3>
    <pre style="background: #f0f0f0; padding: 20px; border-radius: 5px; overflow-x: auto;">
<script>
(function() {
  // Prevent duplicate loading
  if (window.SentientIQ_loaded) return;
  window.SentientIQ_loaded = true;

  // Configuration - CUSTOMIZE THESE VALUES
  var TENANT_ID = 'sidk';  // Your tenant ID
  var API_KEY = 'sq_live_sidk_test';  // Your API key
  var API_ENDPOINT = 'https://api.sentientiq.app';  // Backend API

  // Initialize SentientIQ namespace
  window.SentientIQ = window.SentientIQ || {};
  window.SentientIQ.config = {
    tenantId: TENANT_ID,
    apiKey: API_KEY,
    apiEndpoint: API_ENDPOINT,
    debug: true  // Set to false in production
  };

  // Store in localStorage for persistence
  localStorage.setItem('tenantId', TENANT_ID);
  localStorage.setItem('apiKey', API_KEY);
  localStorage.setItem('apiEndpoint', API_ENDPOINT);

  // Helper function to load scripts
  function loadScript(src, onLoad) {
    var script = document.createElement('script');
    script.src = src;
    script.async = true;
    if (onLoad) script.onload = onLoad;
    script.onerror = function() {
      console.error('[SentientIQ] Failed to load script:', src);
    };
    document.head.appendChild(script);
  }

  // Load detection script first
  console.log('[SentientIQ] Loading detection script...');
  loadScript(
    'https://sentientiq.ai/detect-v4.js?tenant=' + TENANT_ID + '&key=' + API_KEY,
    function() {
      console.log('[SentientIQ] Detection script loaded successfully');

      // Ensure the emotions tracking is available
      if (window.SentientIQ && window.SentientIQ.getEmotionHistory) {
        window.SentientIQ.emotions = window.SentientIQ.getEmotionHistory;
        console.log('[SentientIQ] Emotion tracking initialized');
      }

      // Load interventions script after a small delay to ensure detection is ready
      setTimeout(function() {
        console.log('[SentientIQ] Loading interventions script...');

        // Ensure config is still available
        if (!window.SentientIQ.config) {
          window.SentientIQ.config = {
            tenantId: TENANT_ID,
            apiKey: API_KEY,
            apiEndpoint: API_ENDPOINT
          };
        }

        loadScript(
          'https://sentientiq.ai/interventions-v4.js?tenant=' + TENANT_ID + '&key=' + API_KEY,
          function() {
            console.log('[SentientIQ] Interventions script loaded successfully');

            // Verify everything is working
            if (window.SentientIQ && window.SentientIQ.interventions) {
              console.log('[SentientIQ] ✅ Full system initialized');
              console.log('[SentientIQ] Tenant:', TENANT_ID);
              console.log('[SentientIQ] Emotions:', typeof window.SentientIQ.emotions);
              console.log('[SentientIQ] Interventions:', typeof window.SentientIQ.interventions);
            }
          }
        );
      }, 100);  // 100ms delay to ensure detection is fully initialized
    }
  );

  // Optional: Track GTM initialization event
  if (window.dataLayer) {
    window.dataLayer.push({
      'event': 'sentientiq_initialized',
      'sentientiq_tenant': TENANT_ID,
      'sentientiq_timestamp': new Date().toISOString()
    });
  }
})();
</script>
    </pre>

    <h3>Alternative: Simpler Version (if you don't need debug logging)</h3>
    <pre style="background: #f0f0f0; padding: 20px; border-radius: 5px; overflow-x: auto;">
<script>
(function() {
  if (window.SentientIQ_loaded) return;
  window.SentientIQ_loaded = true;

  // Configuration
  var TENANT_ID = 'sidk';
  var API_KEY = 'sq_live_sidk_test';

  // Initialize
  window.SentientIQ = {
    config: {
      tenantId: TENANT_ID,
      apiKey: API_KEY,
      apiEndpoint: 'https://api.sentientiq.app'
    }
  };

  localStorage.setItem('tenantId', TENANT_ID);
  localStorage.setItem('apiKey', API_KEY);

  // Load detection
  var detect = document.createElement('script');
  detect.src = 'https://sentientiq.ai/detect-v4.js?tenant=' + TENANT_ID + '&key=' + API_KEY;
  detect.onload = function() {
    // Bridge emotion tracking
    if (window.SentientIQ.getEmotionHistory) {
      window.SentientIQ.emotions = window.SentientIQ.getEmotionHistory;
    }

    // Load interventions
    setTimeout(function() {
      var interventions = document.createElement('script');
      interventions.src = 'https://sentientiq.ai/interventions-v4.js?tenant=' + TENANT_ID + '&key=' + API_KEY;
      document.head.appendChild(interventions);
    }, 100);
  };
  document.head.appendChild(detect);
})();
</script>
    </pre>

    <h3>Testing the Installation</h3>
    <p>After installing, open the browser console and check for:</p>
    <pre style="background: #333; color: #0f0; padding: 15px; border-radius: 5px;">
[SentientIQ] Loading detection script...
[SentientIQ] Detection script loaded successfully
[SentientIQ] Emotion tracking initialized
[SentientIQ] Loading interventions script...
[SentientIQ] Interventions script loaded successfully
[SentientIQ] ✅ Full system initialized
    </pre>

    <h3>Verify in Console:</h3>
    <pre style="background: #f0f0f0; padding: 15px; border-radius: 5px;">
// Check if everything loaded
window.SentientIQ

// Check configuration
window.SentientIQ.config

// Check tenant ID
localStorage.getItem('tenantId')

// Check for scripts
document.querySelectorAll('script[src*="sentientiq.ai"]')

// Get current emotions (after some interaction)
window.SentientIQ.emotions()
    </pre>

    <h3>Key Changes from Previous Version:</h3>
    <ul>
        <li>✅ Correct domain: <code>sentientiq.ai</code> (not .app)</li>
        <li>✅ Proper namespace initialization before script loading</li>
        <li>✅ Bridge between detection and intervention scripts</li>
        <li>✅ Config persistence in both window and localStorage</li>
        <li>✅ Error handling and debug logging</li>
        <li>✅ DataLayer event for GTM tracking</li>
    </ul>

    <h3>Important Notes:</h3>
    <ul>
        <li>The scripts load from <code>https://sentientiq.ai/</code> (marketing website)</li>
        <li>The API calls go to <code>https://api.sentientiq.app</code> (orchestrator)</li>
        <li>Tenant ID: <code>sidk</code> is configured for automotive dealership</li>
        <li>The 100ms delay ensures detection is ready before interventions</li>
        <li>Both scripts need the same tenant ID and API key</li>
    </ul>
</body>
</html>