<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .log { margin: 5px 0; padding: 5px; background: #f0f0f0; }
        .error { background: #ffdddd; }
        .success { background: #ddffdd; }
        button { margin: 10px 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div>
        <button onclick="testDirect()">Test Direct WebSocket</button>
        <button onclick="loadScripts()">Load Real Scripts</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    <div id="logs"></div>

    <script>
        const logs = document.getElementById('logs');

        function log(msg, type = '') {
            const div = document.createElement('div');
            div.className = 'log ' + type;
            div.textContent = `[${new Date().toISOString().split('T')[1].split('.')[0]}] ${msg}`;
            logs.appendChild(div);
            console.log(msg);
        }

        function clearLogs() {
            logs.innerHTML = '';
            sessionStorage.clear();
            localStorage.clear();
            log('Cleared logs and storage');
        }

        function testDirect() {
            log('Testing direct WebSocket connection...');

            const sessionId = `test_${Date.now()}_${Math.random().toString(36).slice(2)}`;
            const wsUrl = `wss://api.sentientiq.app/ws?channel=interventions&session=${sessionId}&tenant=demo`;

            log(`Connecting to: ${wsUrl}`);

            try {
                const ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    log('âœ… WebSocket connected!', 'success');
                    log('Sending test ping...');
                    ws.send(JSON.stringify({ type: 'ping' }));
                };

                ws.onmessage = (event) => {
                    log(`Received: ${event.data}`, 'success');
                };

                ws.onerror = (error) => {
                    log(`Error: ${error.type || 'Connection failed'}`, 'error');
                };

                ws.onclose = (event) => {
                    log(`Closed: Code ${event.code}, Reason: ${event.reason || 'Unknown'}`, 'error');
                };

                window.testWs = ws;
            } catch (e) {
                log(`Exception: ${e.message}`, 'error');
            }
        }

        function loadScripts() {
            log('Loading real scripts...');

            // Set up window.SentientIQ
            window.SentientIQ = {
                apiEndpoint: 'https://api.sentientiq.app',
                tenantId: 'demo',
                apiKey: 'sq_demo_v5'
            };

            // Load telemetry first
            const telemetryScript = document.createElement('script');
            telemetryScript.src = '/telemetry-v5.js';
            telemetryScript.onload = () => {
                log('Telemetry loaded', 'success');

                // Check session storage
                const sessionId = sessionStorage.getItem('sq_session_id');
                if (sessionId) {
                    log(`Session ID set: ${sessionId}`, 'success');
                } else {
                    log('No session ID in storage yet!', 'error');
                }

                // Load intervention receiver after delay
                setTimeout(() => {
                    const interventionScript = document.createElement('script');
                    interventionScript.src = '/intervention-receiver.js';
                    interventionScript.onload = () => {
                        log('Intervention receiver loaded', 'success');

                        // Check WebSocket status
                        setTimeout(() => {
                            if (window.SentientIQInterventions && window.SentientIQInterventions.ws()) {
                                const ws = window.SentientIQInterventions.ws();
                                log(`WebSocket state: ${ws.readyState} (0=CONNECTING, 1=OPEN, 2=CLOSING, 3=CLOSED)`);
                            } else {
                                log('No WebSocket found in SentientIQInterventions', 'error');
                            }
                        }, 1000);
                    };
                    document.head.appendChild(interventionScript);
                }, 500);
            };
            document.head.appendChild(telemetryScript);
        }

        // Auto-run direct test on load
        setTimeout(testDirect, 1000);
    </script>
</body>
</html>